
// RGB for color index 0..255
let _viridis =
[
    [ 68, 1, 84 ],
    [ 68, 2, 85 ],
    [ 68, 3, 87 ],
    [ 69, 5, 88 ],
    [ 69, 6, 90 ],
    [ 69, 8, 91 ],
    [ 70, 9, 92 ],
    [ 70, 11, 94 ],
    [ 70, 12, 95 ],
    [ 70, 14, 97 ],
    [ 71, 15, 98 ],
    [ 71, 17, 99 ],
    [ 71, 18, 101 ],
    [ 71, 20, 102 ],
    [ 71, 21, 103 ],
    [ 71, 22, 105 ],
    [ 71, 24, 106 ],
    [ 72, 25, 107 ],
    [ 72, 26, 108 ],
    [ 72, 28, 110 ],
    [ 72, 29, 111 ],
    [ 72, 30, 112 ],
    [ 72, 32, 113 ],
    [ 72, 33, 114 ],
    [ 72, 34, 115 ],
    [ 72, 35, 116 ],
    [ 71, 37, 117 ],
    [ 71, 38, 118 ],
    [ 71, 39, 119 ],
    [ 71, 40, 120 ],
    [ 71, 42, 121 ],
    [ 71, 43, 122 ],
    [ 71, 44, 123 ],
    [ 70, 45, 124 ],
    [ 70, 47, 124 ],
    [ 70, 48, 125 ],
    [ 70, 49, 126 ],
    [ 69, 50, 127 ],
    [ 69, 52, 127 ],
    [ 69, 53, 128 ],
    [ 69, 54, 129 ],
    [ 68, 55, 129 ],
    [ 68, 57, 130 ],
    [ 67, 58, 131 ],
    [ 67, 59, 131 ],
    [ 67, 60, 132 ],
    [ 66, 61, 132 ],
    [ 66, 62, 133 ],
    [ 66, 64, 133 ],
    [ 65, 65, 134 ],
    [ 65, 66, 134 ],
    [ 64, 67, 135 ],
    [ 64, 68, 135 ],
    [ 63, 69, 135 ],
    [ 63, 71, 136 ],
    [ 62, 72, 136 ],
    [ 62, 73, 137 ],
    [ 61, 74, 137 ],
    [ 61, 75, 137 ],
    [ 61, 76, 137 ],
    [ 60, 77, 138 ],
    [ 60, 78, 138 ],
    [ 59, 80, 138 ],
    [ 59, 81, 138 ],
    [ 58, 82, 139 ],
    [ 58, 83, 139 ],
    [ 57, 84, 139 ],
    [ 57, 85, 139 ],
    [ 56, 86, 139 ],
    [ 56, 87, 140 ],
    [ 55, 88, 140 ],
    [ 55, 89, 140 ],
    [ 54, 90, 140 ],
    [ 54, 91, 140 ],
    [ 53, 92, 140 ],
    [ 53, 93, 140 ],
    [ 52, 94, 141 ],
    [ 52, 95, 141 ],
    [ 51, 96, 141 ],
    [ 51, 97, 141 ],
    [ 50, 98, 141 ],
    [ 50, 99, 141 ],
    [ 49, 100, 141 ],
    [ 49, 101, 141 ],
    [ 49, 102, 141 ],
    [ 48, 103, 141 ],
    [ 48, 104, 141 ],
    [ 47, 105, 141 ],
    [ 47, 106, 141 ],
    [ 46, 107, 142 ],
    [ 46, 108, 142 ],
    [ 46, 109, 142 ],
    [ 45, 110, 142 ],
    [ 45, 111, 142 ],
    [ 44, 112, 142 ],
    [ 44, 113, 142 ],
    [ 44, 114, 142 ],
    [ 43, 115, 142 ],
    [ 43, 116, 142 ],
    [ 42, 117, 142 ],
    [ 42, 118, 142 ],
    [ 42, 119, 142 ],
    [ 41, 120, 142 ],
    [ 41, 121, 142 ],
    [ 40, 122, 142 ],
    [ 40, 122, 142 ],
    [ 40, 123, 142 ],
    [ 39, 124, 142 ],
    [ 39, 125, 142 ],
    [ 39, 126, 142 ],
    [ 38, 127, 142 ],
    [ 38, 128, 142 ],
    [ 38, 129, 142 ],
    [ 37, 130, 142 ],
    [ 37, 131, 141 ],
    [ 36, 132, 141 ],
    [ 36, 133, 141 ],
    [ 36, 134, 141 ],
    [ 35, 135, 141 ],
    [ 35, 136, 141 ],
    [ 35, 137, 141 ],
    [ 34, 137, 141 ],
    [ 34, 138, 141 ],
    [ 34, 139, 141 ],
    [ 33, 140, 141 ],
    [ 33, 141, 140 ],
    [ 33, 142, 140 ],
    [ 32, 143, 140 ],
    [ 32, 144, 140 ],
    [ 32, 145, 140 ],
    [ 31, 146, 140 ],
    [ 31, 147, 139 ],
    [ 31, 148, 139 ],
    [ 31, 149, 139 ],
    [ 31, 150, 139 ],
    [ 30, 151, 138 ],
    [ 30, 152, 138 ],
    [ 30, 153, 138 ],
    [ 30, 153, 138 ],
    [ 30, 154, 137 ],
    [ 30, 155, 137 ],
    [ 30, 156, 137 ],
    [ 30, 157, 136 ],
    [ 30, 158, 136 ],
    [ 30, 159, 136 ],
    [ 30, 160, 135 ],
    [ 31, 161, 135 ],
    [ 31, 162, 134 ],
    [ 31, 163, 134 ],
    [ 32, 164, 133 ],
    [ 32, 165, 133 ],
    [ 33, 166, 133 ],
    [ 33, 167, 132 ],
    [ 34, 167, 132 ],
    [ 35, 168, 131 ],
    [ 35, 169, 130 ],
    [ 36, 170, 130 ],
    [ 37, 171, 129 ],
    [ 38, 172, 129 ],
    [ 39, 173, 128 ],
    [ 40, 174, 127 ],
    [ 41, 175, 127 ],
    [ 42, 176, 126 ],
    [ 43, 177, 125 ],
    [ 44, 177, 125 ],
    [ 46, 178, 124 ],
    [ 47, 179, 123 ],
    [ 48, 180, 122 ],
    [ 50, 181, 122 ],
    [ 51, 182, 121 ],
    [ 53, 183, 120 ],
    [ 54, 184, 119 ],
    [ 56, 185, 118 ],
    [ 57, 185, 118 ],
    [ 59, 186, 117 ],
    [ 61, 187, 116 ],
    [ 62, 188, 115 ],
    [ 64, 189, 114 ],
    [ 66, 190, 113 ],
    [ 68, 190, 112 ],
    [ 69, 191, 111 ],
    [ 71, 192, 110 ],
    [ 73, 193, 109 ],
    [ 75, 194, 108 ],
    [ 77, 194, 107 ],
    [ 79, 195, 105 ],
    [ 81, 196, 104 ],
    [ 83, 197, 103 ],
    [ 85, 198, 102 ],
    [ 87, 198, 101 ],
    [ 89, 199, 100 ],
    [ 91, 200, 98 ],
    [ 94, 201, 97 ],
    [ 96, 201, 96 ],
    [ 98, 202, 95 ],
    [ 100, 203, 93 ],
    [ 103, 204, 92 ],
    [ 105, 204, 91 ],
    [ 107, 205, 89 ],
    [ 109, 206, 88 ],
    [ 112, 206, 86 ],
    [ 114, 207, 85 ],
    [ 116, 208, 84 ],
    [ 119, 208, 82 ],
    [ 121, 209, 81 ],
    [ 124, 210, 79 ],
    [ 126, 210, 78 ],
    [ 129, 211, 76 ],
    [ 131, 211, 75 ],
    [ 134, 212, 73 ],
    [ 136, 213, 71 ],
    [ 139, 213, 70 ],
    [ 141, 214, 68 ],
    [ 144, 214, 67 ],
    [ 146, 215, 65 ],
    [ 149, 215, 63 ],
    [ 151, 216, 62 ],
    [ 154, 216, 60 ],
    [ 157, 217, 58 ],
    [ 159, 217, 56 ],
    [ 162, 218, 55 ],
    [ 165, 218, 53 ],
    [ 167, 219, 51 ],
    [ 170, 219, 50 ],
    [ 173, 220, 48 ],
    [ 175, 220, 46 ],
    [ 178, 221, 44 ],
    [ 181, 221, 43 ],
    [ 183, 221, 41 ],
    [ 186, 222, 39 ],
    [ 189, 222, 38 ],
    [ 191, 223, 36 ],
    [ 194, 223, 34 ],
    [ 197, 223, 33 ],
    [ 199, 224, 31 ],
    [ 202, 224, 30 ],
    [ 205, 224, 29 ],
    [ 207, 225, 28 ],
    [ 210, 225, 27 ],
    [ 212, 225, 26 ],
    [ 215, 226, 25 ],
    [ 218, 226, 24 ],
    [ 220, 226, 24 ],
    [ 223, 227, 24 ],
    [ 225, 227, 24 ],
    [ 228, 227, 24 ],
    [ 231, 228, 25 ],
    [ 233, 228, 25 ],
    [ 236, 228, 26 ],
    [ 238, 229, 27 ],
    [ 241, 229, 28 ],
    [ 243, 229, 30 ],
    [ 246, 230, 31 ],
    [ 248, 230, 33 ],
    [ 250, 230, 34 ],
    [ 253, 231, 36 ]
];

// import matplotlib.pyplot as plt
// map = plt.get_cmap('viridis')
// map = plt.get_cmap('magma')
// for i,c in enumerate(map.colors):
//     print("    [ %3d, %3d, %3d ]," % ( c[0]*255, c[1]*255, c[2]*255) )
let _magma =
[
    [   0,   0,   3 ],
    [   0,   0,   4 ],
    [   0,   0,   6 ],
    [   1,   0,   7 ],
    [   1,   1,   9 ],
    [   1,   1,  11 ],
    [   2,   2,  13 ],
    [   2,   2,  15 ],
    [   3,   3,  17 ],
    [   4,   3,  19 ],
    [   4,   4,  21 ],
    [   5,   4,  23 ],
    [   6,   5,  25 ],
    [   7,   5,  27 ],
    [   8,   6,  29 ],
    [   9,   7,  31 ],
    [  10,   7,  34 ],
    [  11,   8,  36 ],
    [  12,   9,  38 ],
    [  13,  10,  40 ],
    [  14,  10,  42 ],
    [  15,  11,  44 ],
    [  16,  12,  47 ],
    [  17,  12,  49 ],
    [  18,  13,  51 ],
    [  20,  13,  53 ],
    [  21,  14,  56 ],
    [  22,  14,  58 ],
    [  23,  15,  60 ],
    [  24,  15,  63 ],
    [  26,  16,  65 ],
    [  27,  16,  68 ],
    [  28,  16,  70 ],
    [  30,  16,  73 ],
    [  31,  17,  75 ],
    [  32,  17,  77 ],
    [  34,  17,  80 ],
    [  35,  17,  82 ],
    [  37,  17,  85 ],
    [  38,  17,  87 ],
    [  40,  17,  89 ],
    [  42,  17,  92 ],
    [  43,  17,  94 ],
    [  45,  16,  96 ],
    [  47,  16,  98 ],
    [  48,  16, 101 ],
    [  50,  16, 103 ],
    [  52,  16, 104 ],
    [  53,  15, 106 ],
    [  55,  15, 108 ],
    [  57,  15, 110 ],
    [  59,  15, 111 ],
    [  60,  15, 113 ],
    [  62,  15, 114 ],
    [  64,  15, 115 ],
    [  66,  15, 116 ],
    [  67,  15, 117 ],
    [  69,  15, 118 ],
    [  71,  15, 119 ],
    [  72,  16, 120 ],
    [  74,  16, 121 ],
    [  75,  16, 121 ],
    [  77,  17, 122 ],
    [  79,  17, 123 ],
    [  80,  18, 123 ],
    [  82,  18, 124 ],
    [  83,  19, 124 ],
    [  85,  19, 125 ],
    [  87,  20, 125 ],
    [  88,  21, 126 ],
    [  90,  21, 126 ],
    [  91,  22, 126 ],
    [  93,  23, 126 ],
    [  94,  23, 127 ],
    [  96,  24, 127 ],
    [  97,  24, 127 ],
    [  99,  25, 127 ],
    [ 101,  26, 128 ],
    [ 102,  26, 128 ],
    [ 104,  27, 128 ],
    [ 105,  28, 128 ],
    [ 107,  28, 128 ],
    [ 108,  29, 128 ],
    [ 110,  30, 129 ],
    [ 111,  30, 129 ],
    [ 113,  31, 129 ],
    [ 115,  31, 129 ],
    [ 116,  32, 129 ],
    [ 118,  33, 129 ],
    [ 119,  33, 129 ],
    [ 121,  34, 129 ],
    [ 122,  34, 129 ],
    [ 124,  35, 129 ],
    [ 126,  36, 129 ],
    [ 127,  36, 129 ],
    [ 129,  37, 129 ],
    [ 130,  37, 129 ],
    [ 132,  38, 129 ],
    [ 133,  38, 129 ],
    [ 135,  39, 129 ],
    [ 137,  40, 129 ],
    [ 138,  40, 129 ],
    [ 140,  41, 128 ],
    [ 141,  41, 128 ],
    [ 143,  42, 128 ],
    [ 145,  42, 128 ],
    [ 146,  43, 128 ],
    [ 148,  43, 128 ],
    [ 149,  44, 128 ],
    [ 151,  44, 127 ],
    [ 153,  45, 127 ],
    [ 154,  45, 127 ],
    [ 156,  46, 127 ],
    [ 158,  46, 126 ],
    [ 159,  47, 126 ],
    [ 161,  47, 126 ],
    [ 163,  48, 126 ],
    [ 164,  48, 125 ],
    [ 166,  49, 125 ],
    [ 167,  49, 125 ],
    [ 169,  50, 124 ],
    [ 171,  51, 124 ],
    [ 172,  51, 123 ],
    [ 174,  52, 123 ],
    [ 176,  52, 123 ],
    [ 177,  53, 122 ],
    [ 179,  53, 122 ],
    [ 181,  54, 121 ],
    [ 182,  54, 121 ],
    [ 184,  55, 120 ],
    [ 185,  55, 120 ],
    [ 187,  56, 119 ],
    [ 189,  57, 119 ],
    [ 190,  57, 118 ],
    [ 192,  58, 117 ],
    [ 194,  58, 117 ],
    [ 195,  59, 116 ],
    [ 197,  60, 116 ],
    [ 198,  60, 115 ],
    [ 200,  61, 114 ],
    [ 202,  62, 114 ],
    [ 203,  62, 113 ],
    [ 205,  63, 112 ],
    [ 206,  64, 112 ],
    [ 208,  65, 111 ],
    [ 209,  66, 110 ],
    [ 211,  66, 109 ],
    [ 212,  67, 109 ],
    [ 214,  68, 108 ],
    [ 215,  69, 107 ],
    [ 217,  70, 106 ],
    [ 218,  71, 105 ],
    [ 220,  72, 105 ],
    [ 221,  73, 104 ],
    [ 222,  74, 103 ],
    [ 224,  75, 102 ],
    [ 225,  76, 102 ],
    [ 226,  77, 101 ],
    [ 228,  78, 100 ],
    [ 229,  80,  99 ],
    [ 230,  81,  98 ],
    [ 231,  82,  98 ],
    [ 232,  84,  97 ],
    [ 234,  85,  96 ],
    [ 235,  86,  96 ],
    [ 236,  88,  95 ],
    [ 237,  89,  95 ],
    [ 238,  91,  94 ],
    [ 238,  93,  93 ],
    [ 239,  94,  93 ],
    [ 240,  96,  93 ],
    [ 241,  97,  92 ],
    [ 242,  99,  92 ],
    [ 243, 101,  92 ],
    [ 243, 103,  91 ],
    [ 244, 104,  91 ],
    [ 245, 106,  91 ],
    [ 245, 108,  91 ],
    [ 246, 110,  91 ],
    [ 246, 112,  91 ],
    [ 247, 113,  91 ],
    [ 247, 115,  92 ],
    [ 248, 117,  92 ],
    [ 248, 119,  92 ],
    [ 249, 121,  92 ],
    [ 249, 123,  93 ],
    [ 249, 125,  93 ],
    [ 250, 127,  94 ],
    [ 250, 128,  94 ],
    [ 250, 130,  95 ],
    [ 251, 132,  96 ],
    [ 251, 134,  96 ],
    [ 251, 136,  97 ],
    [ 251, 138,  98 ],
    [ 252, 140,  99 ],
    [ 252, 142,  99 ],
    [ 252, 144, 100 ],
    [ 252, 146, 101 ],
    [ 252, 147, 102 ],
    [ 253, 149, 103 ],
    [ 253, 151, 104 ],
    [ 253, 153, 105 ],
    [ 253, 155, 106 ],
    [ 253, 157, 107 ],
    [ 253, 159, 108 ],
    [ 253, 161, 110 ],
    [ 253, 162, 111 ],
    [ 253, 164, 112 ],
    [ 254, 166, 113 ],
    [ 254, 168, 115 ],
    [ 254, 170, 116 ],
    [ 254, 172, 117 ],
    [ 254, 174, 118 ],
    [ 254, 175, 120 ],
    [ 254, 177, 121 ],
    [ 254, 179, 123 ],
    [ 254, 181, 124 ],
    [ 254, 183, 125 ],
    [ 254, 185, 127 ],
    [ 254, 187, 128 ],
    [ 254, 188, 130 ],
    [ 254, 190, 131 ],
    [ 254, 192, 133 ],
    [ 254, 194, 134 ],
    [ 254, 196, 136 ],
    [ 254, 198, 137 ],
    [ 254, 199, 139 ],
    [ 254, 201, 141 ],
    [ 254, 203, 142 ],
    [ 253, 205, 144 ],
    [ 253, 207, 146 ],
    [ 253, 209, 147 ],
    [ 253, 210, 149 ],
    [ 253, 212, 151 ],
    [ 253, 214, 152 ],
    [ 253, 216, 154 ],
    [ 253, 218, 156 ],
    [ 253, 220, 157 ],
    [ 253, 221, 159 ],
    [ 253, 223, 161 ],
    [ 253, 225, 163 ],
    [ 252, 227, 165 ],
    [ 252, 229, 166 ],
    [ 252, 230, 168 ],
    [ 252, 232, 170 ],
    [ 252, 234, 172 ],
    [ 252, 236, 174 ],
    [ 252, 238, 176 ],
    [ 252, 240, 177 ],
    [ 252, 241, 179 ],
    [ 252, 243, 181 ],
    [ 252, 245, 183 ],
    [ 251, 247, 185 ],
    [ 251, 249, 187 ],
    [ 251, 250, 189 ],
    [ 251, 252, 191 ]
];

let _grayscale = [];
for (let i=0; i<256; ++i)
    _grayscale.push([ i, i, i]);

// Off-screen canvas used to draw image for data width x height
// Shared by all images
let _img_buf = document.createElement('canvas');

function __redraw_image_with_data(widget, data)
{
    // Chrome's Performance monitor shows that most of the time for handling an image
    // update is spent in here. .. as expected.
    // Create the image in Worker thread?
    // Would have to postMessage() the data.value into the worker and
    // then get the image back out via addEventListener().
    // Do those data copies defeat the purpose?
    // but https://developer.mozilla.org/en-US/docs/Web/API/Transferable
    // might help to avoid copies.
    // Or try http://keithwhor.github.io/multithread.js to get started.

    let canvas = widget.get(0);

    let colormap = widget.data('colormap');

    // Data width, height, range
    let wid = widget.data("width"), min = widget.data("min"), max = widget.data("max");
    let hei;
    if (data === undefined  ||  data.value == undefined)
        hei = 0;
    else
        hei = Math.floor(data.value.length / wid);

    // Screen width, height
    let scr_wid = canvas.width, scr_hei = canvas.height;

    // console.log("Image update: " + data.value.length + " elements for " + wid + "x" + hei +
    //             " (" + scr_wid + "x" + scr_hei + "px)" +
    //             ", range " + min + " .. " + max);

    // console.log("Image update: size " + wid + "x" + hei);

    if (hei <= 0)
    {
        let gc = canvas.getContext("2d", { alpha: false });
        gc.imageSmoothingEnabled = false;

        gc.fillStyle = "rgb(68, 1, 84)";
        gc.fillRect(0, 0, scr_wid, scr_hei);
        gc.fillStyle = "yellow";
        gc.font = '25px serif';
        gc.fillText('No data', 10, 30);
        return;
    }

    // Auto-scale the value range by determining the overall max
    // (only possible if there is data, hei > 0)
    // Leaving min unchanged
    if (widget.data("autoscale"))
        max = data.value.reduce( (a, b) => Math.max(a, b) );

    // Draw data into the off-screen image buffer canvas
    _img_buf.width = wid;
    _img_buf.height = hei;
    let gc = _img_buf.getContext("2d", { alpha: false });
    let img = gc.createImageData(wid, hei);
    let vi=0, i=0;
    let crange = 255 / (max - min);
    for (let y=0; y<hei; ++y)
        for (let x=0; x<wid; ++x)
        {
            let v = data.value[vi++];
            let c = Math.round((v - min) * crange);
            let m;
            if (c < 0)
                m = colormap[0];
            else if (c > 255)
                m = colormap[255];
            else
                m = colormap[c];
            img.data[i++] = m[0];
            img.data[i++] = m[1];
            img.data[i++] = m[2];
            img.data[i++] = 255;
        }
    gc.putImageData(img, 0, 0);

    // Scale onto display canvas
    gc = canvas.getContext("2d", { alpha: false });
    gc.imageSmoothingEnabled = scr_wid < wid;
    gc.drawImage(_img_buf, 0, 0, scr_wid, scr_hei);
}

function __redraw_image(widget)
{
    let data = dbwr.pv_infos[widget.data("pv")].data;
    __redraw_image_with_data(widget, data);
}

// Called by rules for 'maximum'
function set_image_maximum(widget, maximum)
{
    widget.data("max", maximum);
    // console.log("Rule sets image " + widget.attr('id') + " max to " + maximum + ", redrawing");
    __redraw_image(widget);
}

// Called by rules for 'data_width'
function set_image_data_width(widget, width)
{
    widget.data("width", width);
    // console.log("Rule sets image " + widget.attr('id') + " data_width to " + width + ", redrawing");
    __redraw_image(widget);
}

DisplayBuilderWebRuntime.prototype.widget_update_methods["image"] = __redraw_image_with_data;

DisplayBuilderWebRuntime.prototype.widget_init_methods["image"] = function(widget)
{
    // Turn color map name into actual color map
    if (widget.data('colormap') == "magma")
        widget.data('colormap', _magma);
    else if (widget.data('colormap') == "gray")
        widget.data('colormap', _grayscale);
    else
        // Default
        widget.data('colormap', _viridis);

    // Image colormap, min/max, autoscale config UI for context menu
    let viridis = jQuery("<input>").attr("type", "radio").attr("name", "colormap");
    viridis.click(() =>
    {
        widget.data('colormap', _viridis);
        __redraw_image(widget);
    });

    let magma = jQuery("<input>").attr("type", "radio").attr("name", "colormap");
    magma.click(() =>
    {
        widget.data('colormap', _magma);
        __redraw_image(widget);
    });

    let gray = jQuery("<input>").attr("type", "radio").attr("name", "colormap");
    gray.click(() =>
    {
        widget.data('colormap', _grayscale);
        __redraw_image(widget);
    });

    let mintext = jQuery("<input>").attr("type", "text");
    mintext.change(event =>
    {
        widget.data("min", parseFloat(mintext.val()));
        __redraw_image(widget);
    });

    let maxtext = jQuery("<input>").attr("type", "text");
    maxtext.change(event =>
    {
        widget.data("max", parseFloat(maxtext.val()));
        __redraw_image(widget);
    });

    let checkbox = jQuery("<input>").attr("type", "checkbox");
    checkbox.click(event =>
    {
        widget.data("autoscale", checkbox.prop('checked'));
        __redraw_image(widget);
    });

    create_contextmenu(widget,
                       [
                           jQuery("<div class=\"Header\">").append("Image Settings"),
                           jQuery("<div>").append(jQuery("<label>").append(viridis).append(" Viridis "))
                                          .append(jQuery("<label>").append(magma).append("  Magma "))
                                          .append(jQuery("<label>").append(gray).append(" Grayscale ")),
                           jQuery("<label>").append("Min: ").append(mintext),
                           jQuery("<label>").append("Max: ").append(maxtext),
                           jQuery("<label>").append(checkbox).append("&nbsp; Autoscale")

                       ]);

    widget.click(event =>
    {
        // Update menu UI from image widget

        viridis.prop('checked', widget.data("colormap") === _viridis);
        magma.prop('checked', widget.data("colormap") === _magma);
        gray.prop('checked', widget.data("colormap") === _grayscale);


        checkbox.prop('checked', widget.data("autoscale"));
        mintext.val(widget.data("min"));
        maxtext.val(widget.data("max"));

        toggle_contextmenu(event);
    });
}

